/**
 * Motor del Phishing Quiz - Versi√≥n Anal√≠tica Avanzada
 * Localizaci√≥n: ../assets/js/quiz.js
 */

let currentIdx = 0; 
let score = 0; 
let failedVectors = []; 
let startTime; 
let userAlias = "";
let isAnswering = false; 

// Objetos para anal√≠tica
let sessionAnalytics = {
    timesPerQuestion: [], // Guarda segundos por cada pregunta
    failedIds: {}         // Cuenta cu√°ntas veces se falla cada ID de escenario
};
let questionStartTime;

// --- INICIO Y NAVEGACI√ìN ---

window.startQuiz = function() {
    userAlias = document.getElementById('user-alias').value.trim();
    if (!userAlias) { alert("Ingresa un alias para el registro."); return; }
    
    // Reiniciar todo
    currentIdx = 0; score = 0; failedVectors = [];
    sessionAnalytics.timesPerQuestion = [];
    sessionAnalytics.failedIds = {};
    startTime = Date.now();
    
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('final-score').style.display = 'none';
    document.getElementById('quiz-engine').style.display = 'block';
    renderScenario();
};

window.jumpToRanking = function() {
    document.getElementById('quiz-intro').style.display = 'none';
    document.getElementById('final-score').style.display = 'block';
    document.getElementById('btn-volver-consulta').style.display = 'block';
    document.getElementById('btn-post-quiz').style.display = 'none';
    document.getElementById('percentage').innerText = "üìä";
    document.getElementById('evaluation-text').innerHTML = "Panel de Estad√≠sticas Globales";
    renderLeaderboard();
};

// --- L√ìGICA DEL JUEGO ---

function renderScenario() {
    isAnswering = false; 
    const s = scenarios[currentIdx];
    questionStartTime = Date.now(); // Inicia reloj de la pregunta
    
    document.getElementById('step-title').innerText = `Escenario ${currentIdx + 1} de ${scenarios.length}`;
    document.getElementById('live-points').innerText = `Aciertos: ${score}`;
    
    let content = s.image ? `<center><img src="${s.image}" style="max-width:100%; border-radius:8px; margin-bottom:15px;"></center>` : "";
    document.getElementById('scenario-text').innerHTML = content + s.text;
    document.getElementById('feedback-message').style.display = 'none';
    document.getElementById('quiz-buttons').style.display = 'flex';
}

window.checkAnswer = function(choice) {
    if(isAnswering) return; 
    isAnswering = true;

    const s = scenarios[currentIdx];
    const timeTaken = (Date.now() - questionStartTime) / 1000;
    sessionAnalytics.timesPerQuestion.push(timeTaken);

    const isCorrect = (choice === s.isPhishing);
    
    if(isCorrect) {
        score++;
    } else {
        failedVectors.push(s.vector);
        // Registrar ID fallado para estad√≠stica
        sessionAnalytics.failedIds[s.id] = (sessionAnalytics.failedIds[s.id] || 0) + 1;
    }
    
    const fb = document.getElementById('feedback-message');
    fb.style.display = 'block';
    fb.style.backgroundColor = isCorrect ? '#e6f4ea' : '#fce8e6';
    fb.style.color = isCorrect ? '#1e7e34' : '#c5221f';
    fb.innerHTML = `<strong>${isCorrect ? '‚úì ¬°Correcto!' : '‚úó Identificaci√≥n Err√≥nea'}</strong><br>${s.desc}`;

    document.getElementById('quiz-buttons').style.display = 'none';

    setTimeout(() => {
        currentIdx++;
        if(currentIdx < scenarios.length) renderScenario();
        else showFinalResults();
    }, 4500);
}

// --- PROCESAMIENTO DE ANAL√çTICA ---

function showFinalResults() {
    const totalTime = Math.round((Date.now() - startTime) / 1000);
    const avgTime = (sessionAnalytics.timesPerQuestion.reduce((a,b) => a+b, 0) / scenarios.length).toFixed(1);

    // 1. Identificar tendencia (Vector m√°s fallado)
    let trendText = "Sin errores significativos.";
    if (failedVectors.length > 0) {
        const counts = failedVectors.reduce((a, b) => ({...a, [b]: (a[b] || 0) + 1}), {});
        const worstVector = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        trendText = `Vulnerable a: <b>${worstVector}</b>`;
    }

    // 2. Identificar el escenario m√°s dif√≠cil de la sesi√≥n
    let worstId = Object.keys(sessionAnalytics.failedIds).reduce((a, b) => 
        sessionAnalytics.failedIds[a] > sessionAnalytics.failedIds[b] ? a : b, "Ninguno");

    // Guardar en LocalStorage
    saveUserResult(userAlias, score, totalTime);

    // Mostrar en Pantalla
    document.getElementById('quiz-engine').style.display = 'none';
    document.getElementById('final-score').style.display = 'block';
    document.getElementById('btn-post-quiz').style.display = 'flex';
    document.getElementById('percentage').innerText = `${score}/${scenarios.length}`;

    // Inyectar anal√≠tica detallada
    document.getElementById('evaluation-text').innerHTML = `
        <div style="background: #fdfbff; border: 1px solid #6c1f55; padding: 15px; border-radius: 10px; text-align: left; margin-top: 15px;">
            <p><i class="fas fa-chart-line"></i> <b>Tendencia:</b> ${trendText}</p>
            <p><i class="fas fa-exclamation-triangle"></i> <b>Escenario Cr√≠tico:</b> #${worstId}</p>
            <p><i class="fas fa-clock"></i> <b>Tiempo Promedio:</b> ${avgTime}s por pregunta</p>
            <p><i class="fas fa-hourglass-half"></i> <b>Tiempo Total:</b> ${totalTime}s</p>
        </div>
    `;

    renderLeaderboard();
}

function saveUserResult(alias, s, t) {
    let lb = JSON.parse(localStorage.getItem('phishing_ranking')) || [];
    lb.push({ alias: alias, score: s, time: t, date: new Date().toLocaleDateString() });
    lb.sort((a, b) => b.score - a.score || a.time - b.time);
    localStorage.setItem('phishing_ranking', JSON.stringify(lb.slice(0, 10)));
}

function renderLeaderboard() {
    const data = JSON.parse(localStorage.getItem('phishing_ranking')) || [];
    const list = document.getElementById('ranking-list');
    if(list) {
        list.innerHTML = data.map((u, i) => `
            <tr>
                <td>${i + 1}</td>
                <td style="text-align:left;">${u.alias}</td>
                <td><b>${u.score}/${scenarios.length}</b></td>
                <td>${u.time}s</td>
            </tr>`).join('');
    }
}

window.restartQuiz = function() { window.location.reload(); };
window.goBackToIntro = function() { window.location.reload(); };